# 逻辑优化设计方案

## 目标与约束
- 不修改现有主题与站点源码，通过新增脚本/组件实现逻辑优化。
- 保持原有接口不变，面向 Hexo 渲染链路与前端运行时进行增强。

## 关键节点与优化点
- 渲染阶段（Hexo after_render）
  - 统一处理 `<img>` 标签：注入 `loading="lazy"`、`decoding="async"`，降低首次绘制阻塞与主线程解码开销。
  - 资源提示：在 `</head>` 注入 `preconnect/dns-prefetch`，预热第三方 CDN 链路。
- 运行阶段（浏览器）
  - 输入态保护：在页面加载后为输入控件绑定 `focus/blur`，将 `anzhiyu_intype` 与用户输入态准确联动，避免快捷键误触。

## 设计与兼容性
- 站点级过滤器 `scripts/after_render.js`
  - 无侵入挂载到 Hexo 生命周期，所有页面在生成/预览均自动生效。
  - 幂等与开关：避免重复注入，支持 `BLOG_PATCHES_DISABLE=1` 关闭。
- 前端补丁 `source/js/patches.js`
  - 以注入方式在所有页面加载（`defer`），仅新增事件绑定，不改动主题脚本。
  - 与 PJAX/异步更新兼容（依赖原主题在页面刷新后仍保留 input 元素）。

## 与现有架构的关系
- Hexo 配置与主题架构保持不变。新增脚本通过生命周期注入，与主题 `inject` 机制效果一致但不需改配置。
- 所有优化模块以新增文件存在，不影响主题升级与合并。