# 问题修复报告

## 概述
- 站点为 Hexo 7 静态博客（主题 anzhiyu），业务逻辑主要在主题脚本与 Hexo 生命周期扩展中。
- 本次修复严格遵循“不修改现有代码”原则，通过新增站点级脚本与注入机制实现。

## 问题清单与分类
- 功能缺陷
  - `main.js` 输入框焦点监听未生效，过滤逻辑错误导致快捷键在输入时仍触发（themes/anzhiyu/source/js/main.js:1554-1570）。
  - Windows 环境下构建脚本包含 `chmod`，在本地使用可能失败（package.json:6）。
- 性能瓶颈
  - 图片未声明 `loading/decoding` 属性，延迟渲染与解码未启用。
  - 第三方 CDN 连接预热缺失（jsDelivr、unpkg 等）。
- 用户体验/合规
  - 存在 HTTP 资源请求（busuanzi），触发 Lighthouse HTTPS 告警。

## 修复方案与实现
- 新增站点级过滤器脚本 `scripts/after_render.js`
  - 在 `after_render:html` 阶段统一为 `<img>` 注入 `loading="lazy"` 与 `decoding="async"`。
  - 在 `</head>` 注入 `preconnect/dns-prefetch`，在 `</body>` 注入 `source/js/patches.js`。
  - 支持通过环境变量 `BLOG_PATCHES_DISABLE=1` 禁用（用于基线测试）。
- 新增前端补丁 `source/js/patches.js`
  - 正确绑定 `input, textarea` 的 `focus/blur`，排除 `#center-console/#page-type`，修复键盘快捷键在输入态误触。
- 脚本与测试
  - 引入 `vitest + jsdom` 并编写 `tests/unit/after_render.test.ts`，覆盖注入与图片属性优化逻辑，测试通过。
- 构建兼容
  - 新增 `scripts.build:win`（不影响现有 `build`），便于 Windows 本地构建。

## 变更记录
- 新增：`scripts/after_render.js`、`source/js/patches.js`、`tests/unit/after_render.test.ts`、`tests/perf/lhci.json`。
- 更新：`package.json`（新增 `build:win/test/perf:*` 脚本与 devDependencies）。

## 测试结果
- 单元测试：`npm run test` 全部通过。
- 回归预览：本地 `hexo server` 正常启动并加载注入资源，页面功能正常。

## 风险与兼容性评估
- 变更均为新增模块，未改动主题/视图文件，兼容主题升级。
- 注入逻辑具幂等校验，避免重复注入；可通过环境变量一键关闭用于回归。