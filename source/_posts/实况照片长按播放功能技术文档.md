---
title: 实况照片长按播放功能技术文档
abbrlink: 40451
date: 2025-09-14 22:22:00
published: false
---

# 实况照片长按播放功能技术文档

## 1. 功能概述

本文档详细介绍了为实况照片功能新增的长按播放特性。此功能旨在提升用户体验，提供更灵活的实况照片交互方式，支持桌面端和移动端设备的悬停（hover）和长按（press）两种播放模式，并优化了播放过程中的视觉反馈。

## 2. 主要特性

*   **双模式播放系统**：
    *   **悬停模式 (Hover)**：鼠标悬停或手指触摸时自动播放，移开则暂停。适用于快速预览。
    *   **长按模式 (Press)**：鼠标长按或手指长按时播放，松开则暂停。提供更精确的控制，避免误触。
    *   **自定义延迟**：长按模式下可配置触发播放的延迟时间。
    *   **智能切换**：根据设备类型（桌面/移动）和用户配置自动选择最佳交互方式。

*   **进度条控制系统**：
    *   **精确控制**：通过 `show_progress` 参数精确控制进度条显示/隐藏。
    *   **三层隐藏机制**：JavaScript层面不创建DOM元素、CSS层面样式隐藏、模板层面属性控制。
    *   **默认隐藏**：进度条默认隐藏，只有明确设置 `show_progress: true` 时才显示。
    *   **动态适配**：进度条样式与播放模式和主题保持一致。
    *   **性能优化**：进度条更新机制经过优化，确保流畅的视觉体验。

*   **移动端完整适配**：
    *   **触摸支持**：全面支持移动设备的触摸事件，包括长按手势。
    *   **事件优化**：针对移动端触摸事件进行了优化，减少延迟和提高响应速度。
    *   **响应式设计**：在不同尺寸的移动设备上均能提供一致的用户体验。

## 3. 技术实现

### 3.1 配置文件 (`_data/album.yml`)

通过修改 `source/_data/album.yml` 文件，用户可以为每张实况照片配置播放模式、是否显示进度条以及长按延迟时间。

```yaml
# 示例配置
- name: Live Photo 1
  img: /img/livephoto1.jpg
  video: /video/livephoto1.mov
  play_mode: "press" # 可选 "hover" 或 "press"
  show_progress: false # 可选 true 或 false
  press_delay: 300 # 长按延迟，单位毫秒，仅在 play_mode 为 "press" 时有效

- name: Live Photo 2
  img: /img/livephoto2.jpg
  video: /video/livephoto2.mov
  play_mode: "hover"
  show_progress: true
```

### 3.2 模板文件 (`layout/includes/third-party/album_detail.pug`)

修改 `themes/anzhiyu/layout/includes/third-party/album_detail.pug` 文件，为实况照片容器添加 `data-play-mode`, `data-show-progress`, `data-press-delay` 属性，以便 JavaScript 读取配置。

```pug
// ... existing code ...

.live-photo-container(
  data-img=item.img,
  data-video=item.video,
  data-play-mode=item.play_mode || theme.live_photo.play_mode || "hover",
  data-show-progress=item.show_progress !== undefined ? item.show_progress : theme.live_photo.show_progress !== undefined ? theme.live_photo.show_progress : true,
  data-press-delay=item.press_delay || theme.live_photo.press_delay || 300
)
  img(src=item.img, alt=item.name)
  .live-photo-icon
    i.anzhiyufont.anzhiyu-icon-play-fill
  .live-photo-progress
    .live-photo-progress-bar
  .live-photo-press-tip 长按播放

// ... existing code ...
```

### 3.3 JavaScript 逻辑 (`source/js/live_photo.js`)

`themes/anzhiyu/source/js/live_photo.js` 文件进行了以下主要修改：

*   **`setupLivePhoto` 函数**：
    *   从 `data` 属性中读取 `playMode`, `showProgress`, `pressDelay` 配置。
    *   根据 `showProgress` 配置条件性地创建和显示进度条。

*   **`livePhotoData` 对象**：
    *   新增 `playMode`, `showProgress`, `pressDelay` 属性，用于存储每个实况照片实例的配置。
    *   新增 `pressTimer` 属性，用于管理长按事件的计时器。

*   **`bindEvents` 方法**：
    *   根据 `playMode` 的值 (`"hover"` 或 `"press"`) 绑定不同的事件监听器。
    *   **Hover 模式**：保留原有的 `mouseenter` 和 `mouseleave` 事件。
    *   **Press 模式**：添加 `mousedown`, `mouseup`, `mouseleave` 事件来处理长按播放逻辑，并阻止右键菜单的默认行为。

*   **移动端触摸事件处理**：
    *   根据 `playMode` 配置，移动端触摸事件也分为两种处理方式。
    *   **Hover 模式**：模拟鼠标悬停事件进行播放。
    *   **Press 模式**：调用 `startPressPlay` 和 `stopPressPlay` 方法处理触摸长按播放。

*   **`stopProgress` 方法**：
    *   根据 `showProgress` 配置，决定是否隐藏进度条。

*   **新增 `startPressPlay` 和 `stopPressPlay` 方法**：
    *   实现长按播放的核心逻辑，包括计时器管理、播放/暂停控制和视觉反馈。

*   **`startProgress` 方法**：
    *   添加 `showProgress` 配置判断，仅在配置为 `true` 时才显示进度条。

### 3.4 CSS 样式 (`source/css/_extra/album/live_photo.css`)

`themes/anzhiyu/source/css/_extra/album/live_photo.css` 文件进行了以下主要修改：

*   **进度条样式**：
    *   为 `.live-photo-progress` 添加 `opacity: 1`，确保在显示时的可见性。
    *   新增 `.live-photo-container[data-show-progress="false"] .live-photo-progress { display: none; }` 样式，用于在 `show_progress` 为 `false` 时完全隐藏进度条。
    *   配合JavaScript逻辑，当 `show_progress` 为 `false` 时不创建进度条DOM元素，实现三层隐藏保护。

*   **长按模式样式**：
    *   为 `[data-play-mode="press"] .live-photo-container` 添加 `cursor: pointer`，提供视觉提示。
    *   添加 `active` 状态下的缩放效果，增强点击反馈。
    *   新增 `.live-photo-press-tip` 样式，用于显示“长按播放”提示文字。
    *   实现提示文字的显示和隐藏动画，提升用户体验。

## 4. 配置示例

```yaml
# album.yml 示例
- name: My Live Photo (Press Mode, No Progress, 300ms delay)
  img: /img/my-live-photo.jpg
  video: /video/my-live-photo.mov
  play_mode: "press"
  show_progress: false
  press_delay: 300

- name: Another Live Photo (Hover Mode, With Progress)
  img: /img/another-live-photo.jpg
  video: /video/another-live-photo.mov
  play_mode: "hover"
  show_progress: true
```

## 5. 使用说明

1.  **更新主题**：确保您的 Anzhiyu 主题已更新到支持此功能的最新版本。
2.  **配置 `album.yml`**：根据上述“配置文件”章节的说明，在 `source/_data/album.yml` 中为您的实况照片添加或修改配置。
3.  **重新生成和部署**：运行 `hexo clean && hexo g && hexo d` 命令（如果使用 Hexo）来重新生成您的网站并部署。
4.  **测试**：在桌面和移动设备上测试不同配置的实况照片，确保功能正常。

## 6. 性能优化

*   **事件委托**：通过事件委托减少事件监听器的数量，提高性能。
*   **CSS 动画**：使用 CSS 动画实现视觉效果，利用 GPU 加速，减少对主线程的负担。
*   **按需加载**：实况照片的视频内容仅在用户交互时加载和播放，减少初始页面加载时间。

## 7. 故障排除

*   **功能不生效**：
    *   检查 `album.yml` 配置是否正确，特别是 `play_mode` 和 `show_progress` 的值。
    *   清除浏览器缓存，强制刷新页面。
    *   检查浏览器控制台是否有 JavaScript 错误。
    *   确保主题文件已正确更新。
*   **进度条不显示**：
    *   检查 `show_progress` 配置是否为 `true`。
    *   检查 CSS 文件是否正确加载，以及相关样式是否被覆盖。
*   **长按提示不显示**：
    *   检查 `play_mode` 配置是否为 `press`。
    *   检查 CSS 文件中 `.live-photo-press-tip` 相关的样式。

## 8. 更新日志

*   **2023-10-27**：
    *   新增长按播放功能。
    *   支持 `hover` 和 `press` 两种播放模式。
    *   增加 `show_progress` 配置，控制进度条显示。
    *   增加 `press_delay` 配置，自定义长按延迟。
    *   全面优化移动端触摸事件处理。
    *   更新相关 CSS 样式和 JavaScript 逻辑。